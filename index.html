<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Stock Predictor â€” Reliable</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    :root{--bg:#f6f8fb;--card:#fff;--muted:#667085;--accent:#1f6feb}
    *{box-sizing:border-box}
    body{font-family:Inter,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);margin:0;padding:28px;color:#0f172a}
    .container{max-width:980px;margin:0 auto}
    .card{background:var(--card);border-radius:12px;padding:20px;box-shadow:0 10px 30px rgba(15,23,42,0.06)}
    header{display:flex;align-items:center;gap:16px}
    h1{margin:0;font-size:20px}
    p.lead{margin:8px 0 18px;color:var(--muted)}
    .controls{display:flex;flex-wrap:wrap;gap:12px;align-items:end}
    .field{display:flex;flex-direction:column;font-size:13px}
    input[type=text], input[type=number], select{padding:8px 10px;border-radius:8px;border:1px solid #e6eef8;min-width:140px}
    button{background:var(--accent);color:white;border:none;padding:10px 14px;border-radius:10px;cursor:pointer}
    .meta{display:flex;gap:12px;margin-top:14px;align-items:center}
    .badge{background:#eef4ff;padding:6px 10px;border-radius:8px;font-size:13px;color:#0b4aa6}
    .status{margin-top:12px;color:var(--muted);font-size:13px}
    .row{display:flex;gap:12px;align-items:center;margin-top:14px}
    .price{font-size:18px;font-weight:600}
    canvas{max-width:100%;height:360px}
    .examples{margin-left:auto;font-size:13px}
    .examples button{background:transparent;color:var(--accent);padding:6px;border-radius:8px;border:1px solid transparent}
    #lastUsed{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
    #lastUsed button{padding:4px 8px;font-size:12px;background:#dbeafe;color:#1f6feb;border:none;border-radius:6px;cursor:pointer}
    @media(max-width:720px){.controls{flex-direction:column;align-items:stretch}.examples{margin-left:0}}
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <header>
        <div>
          <h1>ðŸ“ˆ Stock Predictor</h1>
          <p class="lead">Type a ticker, choose how much history to use and how far to predict. Live data is used when available â€” otherwise a demo dataset is displayed so the app always works.</p>
        </div>
        <div class="examples" aria-hidden="true">
          <button id="exA">AAPL</button>
          <button id="exM">MSFT</button>
          <button id="exG">GOOGL</button>
        </div>
      </header>

      <div class="controls" style="margin-top:12px">
        <div class="field">
          <label for="ticker">Ticker</label>
          <input id="ticker" type="text" value="AAPL" autocomplete="off" />
        </div>

        <div class="field">
          <label for="days">History (days)</label>
          <input id="days" type="number" min="20" max="720" value="120" />
        </div>

        <div class="field">
          <label for="horizon">Predict (days)</label>
          <input id="horizon" type="number" min="1" max="60" value="14" />
        </div>

        <div class="field">
          <label for="model">Model</label>
          <select id="model">
            <option value="linear">Linear trend</option>
            <option value="ema">Exponential smoothing</option>
            <option value="naive">Naive average-diff</option>
          </select>
        </div>

        <div style="margin-left:auto">
          <button id="go">Show Prediction</button>
        </div>
      </div>

      <div class="field">
        <label>Last Used Stocks</label>
        <div id="lastUsed"></div>
      </div>

      <div class="meta">
        <div>
          <div class="price" id="current">â€”</div>
          <div class="status" id="change">â€”</div>
        </div>
        <div class="badge" id="source">Live data</div>
      </div>

      <div style="margin-top:14px">
        <canvas id="chart"></canvas>
      </div>

      <div class="status" id="status">Ready â€” click <strong>Show Prediction</strong>.</div>
    </div>
  </div>

  <script>
    const el = id => document.getElementById(id);
    let chart = null;

    function setStatus(txt){ el('status').textContent = txt; }
    function setSource(txt){ el('source').textContent = txt; }
    function formatNum(n){ return (typeof n==='number' && !Number.isNaN(n)) ? n.toFixed(2) : 'â€”'; }

    function demoData(symbol){
      const labels = []; const closes = [];
      const now = new Date();
      const base = (symbol && symbol.toUpperCase()==='AAPL')?150:100 + Math.random()*50;
      for(let i=100;i>0;i--){
        const d = new Date(now); d.setDate(d.getDate()-i);
        labels.push(d.toISOString().slice(0,10));
        const noise = (Math.random()-0.5)*2;
        const trend = (100-i)*0.12;
        closes.push(Number((base + trend + Math.sin(i/6)*3 + noise).toFixed(2)));
      }
      return { labels, closes, meta: {currency: 'USD'} };
    }

    async function fetchYahoo(symbol, days){
      const period2 = Math.floor(Date.now()/1000);
      const period1 = period2 - Math.max(20,days) * 24 * 60 * 60;
      const url = `https://query1.finance.yahoo.com/v8/finance/chart/${encodeURIComponent(symbol)}?period1=${period1}&period2=${period2}&interval=1d&includePrePost=false`;
      const resp = await fetch(url, {cache: 'no-store'});
      if(!resp.ok) throw new Error('HTTP '+resp.status);
      const json = await resp.json();
      return json;
    }

    function parseYahoo(json){
      if(!json || !json.chart || !Array.isArray(json.chart.result) || !json.chart.result[0]) throw new Error('Bad response');
      const r = json.chart.result[0];
      const timestamps = r.timestamp || [];
      const rawCloses = (r.indicators && r.indicators.quote && r.indicators.quote[0] && r.indicators.quote[0].close) || [];
      const meta = r.meta || {};
      const labels = [];
      const closes = [];
      for(let i=0;i<timestamps.length && i<rawCloses.length;i++){
        const c = rawCloses[i];
        if(c === null || Number.isNaN(c)) continue;
        labels.push(new Date(timestamps[i]*1000).toISOString().slice(0,10));
        closes.push(c);
      }
      if(closes.length===0) throw new Error('No close prices');
      return {labels, closes, meta};
    }

    function predictLinear(y, n){
      const m = y.length; if(m===0) return [];
      const xs = Array.from({length:m}, (_,i)=>i);
      const meanX = xs.reduce((a,b)=>a+b,0)/m;
      const meanY = y.reduce((a,b)=>a+b,0)/m;
      let num=0, den=0; for(let i=0;i<m;i++){ num += (xs[i]-meanX)*(y[i]-meanY); den += (xs[i]-meanX)**2; }
      const slope = den===0?0:num/den; const intercept = meanY - slope*meanX;
      const out = []; for(let k=1;k<=n;k++){ out.push(intercept + slope*(m-1+k)); } return out;
    }

    function predictEma(y, n, alpha=0.25){ if(y.length===0) return []; let s=y[0]; for(let i=1;i<y.length;i++) s = alpha*y[i] + (1-alpha)*s; return Array(n).fill(s); }
    function predictNaive(y, n){ if(y.length===0) return []; const diffs=[]; for(let i=1;i<y.length;i++) diffs.push(y[i]-y[i-1]); const avg = diffs.length? diffs.reduce((a,b)=>a+b,0)/diffs.length : 0; const out=[]; let last=y[y.length-1]; for(let i=0;i<n;i++){ last += avg; out.push(last); } return out; }

    function draw(labels, closes, preds, ticker, currency){
      const fullLabels = labels.concat(preds.labels);
      const actuals = closes.concat(Array(preds.values.length).fill(null));
      const predSeries = Array(closes.length).fill(null).concat(preds.values);
      const ctx = el('chart').getContext('2d');
      if(chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'line', data: { labels: fullLabels, datasets: [
          { label: `${ticker.toUpperCase()} Close (${currency||''})`, data: actuals, tension:0.2, borderWidth:2, borderColor:'#1f6feb', pointRadius:0 },
          { label: 'Prediction', data: predSeries, tension:0.2, borderWidth:2, borderDash:[6,6], borderColor:'#ef4444', pointRadius:0 }
        ] },
        options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'bottom'}}, scales:{x:{display:true}, y:{display:true}} }
      });
    }

    // ---------- Last-used ticker logic ----------
    const LAST_USED_KEY = 'lastUsedStocks';
    const MAX_LAST = 5;
    function loadLastUsed(){
      const last = JSON.parse(localStorage.getItem(LAST_USED_KEY) || '[]');
      const container = el('lastUsed');
      container.innerHTML = '';
      last.forEach(sym=>{
        const btn = document.createElement('button');
        btn.textContent = sym;
        btn.addEventListener('click', ()=>{
          el('ticker').value = sym;
          run();
        });
        container.appendChild(btn);
      });
    }
    function saveLastUsed(ticker){
      if(!ticker) return;
      let last = JSON.parse(localStorage.getItem(LAST_USED_KEY) || '[]');
      last = last.filter(s=>s.toUpperCase()!==ticker.toUpperCase());
      last.unshift(ticker.toUpperCase());
      if(last.length>MAX_LAST) last = last.slice(0,MAX_LAST);
      localStorage.setItem(LAST_USED_KEY, JSON.stringify(last));
      loadLastUsed();
    }

    async function run(){
      const ticker = (el('ticker').value || '').trim();
      const days = Number(el('days').value) || 120;
      const horizon = Number(el('horizon').value) || 14;
      const model = el('model').value || 'linear';
      if(!ticker){ setStatus('Please enter a ticker.'); return; }

      setStatus('Trying to load live data...'); setSource('Live data');
      try{
        const json = await fetchYahoo(ticker, days);
        const parsed = parseYahoo(json);
        let predsArr = model==='linear'? predictLinear(parsed.closes,horizon) : model==='ema'? predictEma(parsed.closes,horizon) : predictNaive(parsed.closes,horizon);
        const predLabels = []; const lastDate = parsed.labels.length? new Date(parsed.labels[parsed.labels.length-1]) : new Date();
        for(let i=1;i<=horizon;i++){ const d=new Date(lastDate); d.setDate(d.getDate()+i); predLabels.push(d.toISOString().slice(0,10)); }
        draw(parsed.labels, parsed.closes, {labels: predLabels, values: predsArr.map(v=>Number(v.toFixed(2)))}, ticker, parsed.meta && parsed.meta.currency);

        const current = parsed.meta && parsed.meta.regularMarketPrice || parsed.closes[parsed.closes.length-1];
        const prev = parsed.meta && parsed.meta.chartPreviousClose || parsed.closes[parsed.closes.length-2] || parsed.closes[parsed.closes.length-1];
        el('current').textContent = `Current: ${formatNum(current)} ${parsed.meta && parsed.meta.currency?parsed.meta.currency:''}`;
        const diff = (current - prev); const pct = prev? (diff/prev*100):0; el('change').textContent = `${diff>=0?'+':''}${formatNum(diff)} (${pct.toFixed(2)}%)`;

        setStatus('Live data shown. Predictions are illustrative only.'); setSource('Live data');
      }catch(err){
        console.warn('Live fetch failed â€” falling back to demo:', err);
        const d = demoData(ticker);
        let predsArr = model==='linear'? predictLinear(d.closes,horizon) : model==='ema'? predictEma(d.closes,horizon) : predictNaive(d.closes,horizon);
        const predLabels = []; const lastDate = d.labels.length? new Date(d.labels[d.labels.length-1]) : new Date();
        for(let i=1;i<=horizon;i++){ const dd=new Date(lastDate); dd.setDate(dd.getDate()+i); predLabels.push(dd.toISOString().slice(0,10)); }
        draw(d.labels, d.closes, {labels: predLabels, values: predsArr.map(v=>Number(v.toFixed(2)))}, ticker, d.meta && d.meta.currency);

        const current = d.closes[d.closes.length-1]; const prev = d.closes[d.closes.length-2] || current; const diff=current-prev; const pct = prev? (diff/prev*100):0;
        el('current').textContent = `Demo current: ${formatNum(current)} ${d.meta.currency||''}`;
        el('change').textContent = `${diff>=0?'+':''}${formatNum(diff)} (${pct.toFixed(2)}%)`;
        setSource('Demo data');
        setStatus('Live data unavailable (network or CORS). Showing demo data so the app remains functional.');
      }

      // Save last-used ticker
      saveLastUsed(ticker);
    }

    document.getElementById('exA').addEventListener('click', ()=>{ el('ticker').value='AAPL'; run(); });
    document.getElementById('exM').addEventListener('click', ()=>{ el('ticker').value='MSFT'; run(); });
    document.getElementById('exG').addEventListener('click', ()=>{ el('ticker').value='GOOGL'; run(); });
    document.getElementById('go').addEventListener('click', run);

    // Load last-used tickers on start
    loadLastUsed();
    setStatus('Ready. Enter a ticker and click "Show Prediction".');
  </script>
</body>
</html>
